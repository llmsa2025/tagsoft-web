<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8"/>
    <title>TagSoft Snippet Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto;padding:24px}</style>
  </head>
  <body>
    <h1>Demo: Enviando eventos para a API</h1>
    <p>Abra o console para ver logs. Esta página envia <code>page_view</code> e <code>nota_fiscal_emitida</code>.</p>

    <script>
      // Mini TagSoft client inline (MVP)
      (function (global) {
        const state = { cfg: null };
        function init(cfg){ state.cfg = cfg; }
        async function push(evt){
          const payload = { ...evt, ts: evt.ts || new Date().toISOString() };
          try{
            const ok = navigator.sendBeacon && navigator.sendBeacon(`${state.cfg.endpoint}/v1/ingest`, new Blob([JSON.stringify(payload)], { type:'application/json' }));
            if (!ok) await fetch(`${state.cfg.endpoint}/v1/ingest`, { method:'POST', headers:{'content-type':'application/json','x-api-key': state.cfg.apiKey}, body: JSON.stringify(payload) });
            console.log('[TagSoft] sent', payload);
          }catch(e){ console.error('[TagSoft] error', e); }
        }
        global.TagSoft = { init, push };
      })(window);

      // Configure here:
      const API_URL = (new URLSearchParams(location.search)).get('api') || 'http://localhost:8787';
      const API_KEY = (new URLSearchParams(location.search)).get('key') || 'DEMO_KEY';
      TagSoft.init({ endpoint: API_URL, apiKey: API_KEY });

      TagSoft.push({ event: 'page_view', user: { id: 'u1' }, context: { screen: 'snippet_demo' } });
      setTimeout(() => {
        TagSoft.push({ event: 'nota_fiscal_emitida', user: { id: 'u1', role: 'faturista' }, biz: { valor: 2380.50, itens: 3 } });
      }, 1000);
    </script>
    <p style="margin-top:16px">Dica: você pode passar <code>?api=SEU_API_URL&key=SUA_CHAVE</code> na URL para apontar para sua API no Railway.</p>
  </body>
</html>
