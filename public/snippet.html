<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8"/>
    <title>TagSoft Snippet Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto;padding:24px}
      .log{white-space:pre-wrap;background:#f6f6f6;padding:12px;border-radius:8px;margin-top:12px}
      .ok{color:#0a0}
      .err{color:#b00}
    </style>
  </head>
  <body>
    <h1>Demo: Enviando eventos para a API</h1>
    <p>Esta página envia <code>page_view</code> e <code>nota_fiscal_emitida</code> usando <b>fetch</b> (CORS).</p>

    <div id="status" class="log">—</div>

    <script>
      const params = new URLSearchParams(location.search);
      const API    = (params.get('api') || 'http://localhost:8787').replace(/\/+$/,'');
      const KEY    = params.get('key') || 'DEMO_KEY';

      const statusEl = document.getElementById('status');
      function logOK(msg){ statusEl.innerHTML = '✅ ' + msg; statusEl.className = 'log ok'; }
      function logERR(msg){ statusEl.innerHTML = '❌ ' + msg; statusEl.className = 'log err'; }

      async function send(evt){
        const payload = { ...evt, ts: evt.ts || new Date().toISOString() };
        const res = await fetch(`${API}/v1/ingest`, {
          method: 'POST',
          mode: 'cors',
          credentials: 'omit', // <— evita exigir Access-Control-Allow-Credentials
          headers: {
            'content-type': 'application/json',
            'x-api-key': KEY
          },
          body: JSON.stringify(payload),
          keepalive: true
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text || res.status+' '+res.statusText);
        console.log('[TagSoft] sent', payload);
      }

      (async () => {
        try {
          // evento 1
          await send({ event: 'page_view', user: { id: 'u1' }, context: { screen: 'snippet_demo' } });
          // evento 2
          setTimeout(async () => {
            try {
              await send({ event: 'nota_fiscal_emitida', user: { id: 'u1', role: 'faturista' }, biz: { valor: 2380.50, itens: 3 } });
              logOK('Eventos enviados para ' + API + ' com sucesso.');
            } catch(e) {
              logERR('Falha no segundo evento: ' + e.message);
            }
          }, 800);
        } catch(e) {
          logERR('Falha no primeiro evento: ' + e.message + '\\nAPI=' + API);
        }
      })();
    </script>

    <p style="margin-top:16px">Dica: passe <code>?api=URL&key=API_KEY</code> na URL para apontar para sua API.</p>
  </body>
</html>
